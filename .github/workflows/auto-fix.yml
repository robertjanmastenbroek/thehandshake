name: Auto-Fix on Failure

on:
  workflow_run:
    workflows: ["Moltbook Agent", "Strategist Agent", "Analyst Agent"]
    types:
      - completed

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install anthropic

    - name: Install GitHub CLI
      run: |
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: Authenticate GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "$GH_TOKEN" | gh auth login --with-token

    - name: Run Auto-Fix
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ü§ñ Failed workflow detected: ${{ github.event.workflow_run.name }}"
        echo "üîß Running auto-fix..."

        python3 scripts/auto_fix.py || {
          echo "‚ö†Ô∏è  Auto-fix could not resolve all issues"
          echo "üìã Check logs at: ${{ github.event.workflow_run.html_url }}"
          exit 1
        }

    - name: Notify Success
      if: success()
      run: |
        echo "‚úÖ Auto-fix successful! Fixed issues in ${{ github.event.workflow_run.name }}"
        echo "üîÑ Workflow will re-run automatically to verify fixes"
