name: Deploy and Test

# Runs on every push to main
# Deploys to Railway, then tests all agents

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Railway

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Trigger Railway Deployment
      run: |
        echo "ğŸš‚ Railway auto-deploys on git push"
        echo "âœ“ Deployment will start automatically"
        echo "Monitor at: https://railway.app"

    - name: Wait for deployment
      run: |
        echo "â³ Waiting 60s for Railway deployment..."
        sleep 60

  test-moltbook:
    runs-on: ubuntu-latest
    needs: deploy
    name: Test Moltbook Agent

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Test Moltbook Agent
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        MOLTBOOK_API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
        HANDSHAKE_API_URL: https://thehandshake.io
      run: |
        echo "ğŸ¦ Testing Moltbook Agent..."
        node agents/moltbook_agent.js

    - name: Check for errors
      if: failure()
      run: |
        echo "âŒ Moltbook agent test failed"
        echo "ğŸ¤– Auto-fix workflow will trigger automatically"

  test-api:
    runs-on: ubuntu-latest
    needs: deploy
    name: Test API Endpoints

    steps:
    - name: Test API Health
      run: |
        echo "ğŸ” Testing API endpoints..."

        # Test health
        curl -f https://thehandshake.io/api/health || {
          echo "âŒ Health endpoint failed"
          exit 1
        }

        # Test services endpoint
        curl -f https://thehandshake.io/api/services || {
          echo "âŒ Services endpoint failed"
          exit 1
        }

        echo "âœ… All API endpoints healthy"

  notify:
    runs-on: ubuntu-latest
    needs: [test-moltbook, test-api]
    if: always()
    name: Summary

    steps:
    - name: Deployment Summary
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     ğŸš€ DEPLOYMENT COMPLETE ğŸš€        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ“ Code pushed to GitHub"
        echo "âœ“ Railway deployment triggered"
        echo "âœ“ Agents tested"
        echo "âœ“ API endpoints verified"
        echo ""
        echo "ğŸ”— Links:"
        echo "  â€¢ API: https://thehandshake.io"
        echo "  â€¢ Moltbook: https://www.moltbook.com/u/TheHandshake"
        echo "  â€¢ Actions: https://github.com/${{ github.repository }}/actions"
